<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Worker</title>
<script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="{{static_url('js/Chart.min.js')}}">
  var Chartjs = Chart.noConflict()
</script>
<script>
	$(document).ready(function(){
		$.ajax({
			url: window.location.pathname,
			type: 'POST',
			contentType: 'application/json',
			success: function(data){
				var runtimeLabels = [], sumLabels = [], 
					  cpuPct = [], memPct = [], 
					  readCount = [], writeCount = [], 
					  readBytes = [], writeBytes = [], 
					  runtime = [], 
					  readRates = [], writeRates = [],
					  totalReadBytes = [], totalWriteBytes = [],
					  totalReadCount = [], totalWriteCount = [],
					  avgCpuPct = [], avgMemPct = [];
				for(i = 0; i < data.length; i ++){
					if(data[i].status == 'terminated'){
						runtimeLabels[runtimeLabels.length - 1] = data[i].executable;
						sumLabels.push(data[i].executable);
						runtime.push(data[i].runtime);
						avgCpuPct.push(data[i].avg_cpu_percent);
						avgMemPct.push(data[i].avg_mem_percent);
						//readRates.push(data[i].read_rate);
						//writeRates.push(data[i].write_rate);
						totalReadCount.push(data[i].total_read_count);
						totalWriteCount.push(data[i].total_write_count);
						totalReadBytes.push(data[i].total_read_bytes)	;
						totalWriteBytes.push(data[i].total_write_bytes);
					}
					else{
						runtimeLabels.push('');
						cpuPct.push(data[i].cpu_percent);
						memPct.push(data[i].memory_percent);
						readCount.push(data[i].total_read_count);
						writeCount.push(data[i].total_write_count);
						readBytes.push(data[i].total_read_bytes);
						writeBytes.push(data[i].total_write_bytes);
					}
				}
				var cpuMemChart = new Chart($('#cpu_mem_pct').get(0).getContext('2d')),
					   ioCountChart = new Chart($('#io_count').get(0).getContext('2d')),
					   ioBytesChart = new Chart($('#io_bytes').get(0).getContext('2d')),
					   sumChart = new Chart($('#summary').get(0).getContext('2d'));
				
				var cpuMemData = {
					    labels: runtimeLabels,
					    datasets: [
					        {
					            label: "CPU Percentage",
					            fillColor: "rgba(151,187,205,0.2)",
					            strokeColor: "rgba(151,187,205,1)",
					            pointColor: "rgba(151,187,205,1)",
					            pointStrokeColor: "#fff",
					            pointHighlightFill: "#fff",
					            pointHighlightStroke: "rgba(151,187,205,1)",
					            data: cpuPct
					        },
					        {
					            label: "Memory Percentage",
					            fillColor: "rgba(220,220,220,0.2)",
					            strokeColor: "rgba(220,220,220,1)",
					            pointColor: "rgba(220,220,220,1)",
					            pointStrokeColor: "#fff",
					            pointHighlightFill: "#fff",
					            pointHighlightStroke: "rgba(220,220,220,1)",
					            data: memPct
					        },
					    ]
					},
					ioCountData = {
					    labels: runtimeLabels,
					    datasets: [
					        {
					            label: "Read Count",
					            fillColor: "rgba(151,187,205,0.2)",
					            strokeColor: "rgba(151,187,205,1)",
					            pointColor: "rgba(151,187,205,1)",
					            pointStrokeColor: "#fff",
					            pointHighlightFill: "#fff",
					            pointHighlightStroke: "rgba(151,187,205,1)",
					            data: readCount
					        },
					        {
					            label: "Write Count",
					            fillColor: "rgba(220,220,220,0.2)",
					            strokeColor: "rgba(220,220,220,1)",
					            pointColor: "rgba(220,220,220,1)",
					            pointStrokeColor: "#fff",
					            pointHighlightFill: "#fff",
					            pointHighlightStroke: "rgba(220,220,220,1)",
					            data: writeCount
					        },
					    ]
					},
					ioBytesData = {
						    labels: runtimeLabels,
						    datasets: [
						        {
						            label: "Read Count",
						            fillColor: "rgba(151,187,205,0.2)",
						            strokeColor: "rgba(151,187,205,1)",
						            pointColor: "rgba(151,187,205,1)",
						            pointStrokeColor: "#fff",
						            pointHighlightFill: "#fff",
						            pointHighlightStroke: "rgba(151,187,205,1)",
						            data: readBytes
						        },
						        {
						            label: "Write Count",
						            fillColor: "rgba(220,220,220,0.2)",
						            strokeColor: "rgba(220,220,220,1)",
						            pointColor: "rgba(220,220,220,1)",
						            pointStrokeColor: "#fff",
						            pointHighlightFill: "#fff",
						            pointHighlightStroke: "rgba(220,220,220,1)",
						            data: writeBytes
						        },
						    ]
						};
				
				cpuMemChart.Line(cpuMemData, {bezierCurve: true});
				ioCountChart.Line(ioCountData, {bezierCurve: true});
				ioBytesChart.Line(ioBytesData, {bezierCurve: true});
			}
		});
	});
</script>
</head>
<body>
<canvas id="cpu_mem_pct" width="1500" height="500"></canvas>
<canvas id="io_count" width="1500" height="500"></canvas>
<canvas id="io_bytes" width="1500" height="500"></canvas>
<canvas id="summary" width="1500" height="500"></canvas>
</body>
</html>